<div style="padding: 40px; font-family: system-ui; max-width: 1200px; margin: 0 auto;">
  <h1 style="text-align: center; color: #333;">üéµ VoxQuad SATB Matrix</h1>
  
  <!-- SATB Matrix -->
  <div style="margin: 30px 0; padding: 30px; background: #f8f4ff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
    
    <!-- Voice Controls -->
    <div style="margin-bottom: 20px; display: grid; grid-template-columns: 120px 1fr 1fr 1fr 1fr; gap: 15px; align-items: center;">
      <div></div>
      <div style="text-align: center;">
        <h3 style="margin: 0; color: #666;">Measure 1</h3>
      </div>
      <div style="text-align: center;">
        <h3 style="margin: 0; color: #666;">Measure 2</h3>
      </div>
      <div style="text-align: center;">
        <h3 style="margin: 0; color: #666;">Measure 3</h3>
      </div>
      <div style="text-align: center;">
        <h3 style="margin: 0; color: #666;">Measure 4</h3>
      </div>
    </div>
    
    <!-- Soprano Row -->
    <div style="margin-bottom: 15px; display: grid; grid-template-columns: 120px 1fr 1fr 1fr 1fr; gap: 15px; align-items: center; padding: 10px; background: rgba(255, 192, 203, 0.2); border-radius: 8px;">
      <div style="display: flex; align-items: center; gap: 10px;">
        <strong style="color: #d63384;">Soprano</strong>
        <input type="range" id="sopranoGain" min="0" max="100" value="80" style="width: 50px;" title="Soprano Volume">
      </div>
      <select id="m1_soprano" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px;"></select>
      <select id="m2_soprano" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px;"></select>
      <select id="m3_soprano" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px;"></select>
      <select id="m4_soprano" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px;"></select>
    </div>
    
    <!-- Alto Row -->
    <div style="margin-bottom: 15px; display: grid; grid-template-columns: 120px 1fr 1fr 1fr 1fr; gap: 15px; align-items: center; padding: 10px; background: rgba(255, 193, 7, 0.2); border-radius: 8px;">
      <div style="display: flex; align-items: center; gap: 10px;">
        <strong style="color: #fd7e14;">Alto</strong>
        <input type="range" id="altoGain" min="0" max="100" value="70" style="width: 50px;" title="Alto Volume">
      </div>
      <select id="m1_alto" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px;"></select>
      <select id="m2_alto" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px;"></select>
      <select id="m3_alto" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px;"></select>
      <select id="m4_alto" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px;"></select>
    </div>
    
    <!-- Tenor Row -->
    <div style="margin-bottom: 15px; display: grid; grid-template-columns: 120px 1fr 1fr 1fr 1fr; gap: 15px; align-items: center; padding: 10px; background: rgba(25, 135, 84, 0.2); border-radius: 8px;">
      <div style="display: flex; align-items: center; gap: 10px;">
        <strong style="color: #198754;">Tenor</strong>
        <input type="range" id="tenorGain" min="0" max="100" value="70" style="width: 50px;" title="Tenor Volume">
      </div>
      <select id="m1_tenor" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px;"></select>
      <select id="m2_tenor" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px;"></select>
      <select id="m3_tenor" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px;"></select>
      <select id="m4_tenor" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px;"></select>
    </div>
    
    <!-- Bass Row -->
    <div style="margin-bottom: 20px; display: grid; grid-template-columns: 120px 1fr 1fr 1fr 1fr; gap: 15px; align-items: center; padding: 10px; background: rgba(13, 110, 253, 0.2); border-radius: 8px;">
      <div style="display: flex; align-items: center; gap: 10px;">
        <strong style="color: #0d6efd;">Bass</strong>
        <input type="range" id="bassGain" min="0" max="100" value="90" style="width: 50px;" title="Bass Volume">
      </div>
      <select id="m1_bass" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px;"></select>
      <select id="m2_bass" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px;"></select>
      <select id="m3_bass" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px;"></select>
      <select id="m4_bass" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px;"></select>
    </div>
    
    <!-- Controls -->
    <div style="text-align: center; border-top: 2px solid rgba(156, 39, 176, 0.3); padding-top: 20px;">
      <div style="margin-bottom: 15px;">
        <label style="margin-right: 10px; font-weight: bold;">Master Volume:</label>
        <input type="range" id="masterVolume" min="0" max="100" value="40" style="width: 150px;">
        <span id="masterVolumeValue" style="margin-left: 10px;">40%</span>
      </div>
      
      <button id="playSATB" style="padding: 15px 50px; font-size: 20px; cursor: pointer; background: #9C27B0; color: white; border: none; border-radius: 8px; box-shadow: 0 4px 8px rgba(156, 39, 176, 0.3);">
        ‚ñ∂Ô∏è Play Composition
      </button>
    </div>
  </div>
</div>

<script>
// Create Web Audio API context
let audioContext = null;

// Note options - reusable across all dropdowns
const noteOptions = [
  {value: "65.41", text: "C2"},
  {value: "73.42", text: "D2"},
  {value: "82.41", text: "E2"},
  {value: "87.31", text: "F2"},
  {value: "98.00", text: "G2"},
  {value: "110.00", text: "A2"},
  {value: "123.47", text: "B2"},
  
  {value: "130.81", text: "C3"},
  {value: "146.83", text: "D3"},
  {value: "164.81", text: "E3"},
  {value: "174.61", text: "F3"},
  {value: "196.00", text: "G3"},
  {value: "220.00", text: "A3"},
  {value: "246.94", text: "B3"},
  
  {value: "261.63", text: "C4"},
  {value: "293.66", text: "D4"},
  {value: "329.63", text: "E4"},
  {value: "349.23", text: "F4"},
  {value: "392.00", text: "G4"},
  {value: "440.00", text: "A4"},
  {value: "493.88", text: "B4"},
  
  {value: "523.25", text: "C5"},
  {value: "587.33", text: "D5"},
  {value: "659.25", text: "E5"},
  {value: "698.46", text: "F5"},
  {value: "783.99", text: "G5"},
  {value: "880.00", text: "A5"},
  {value: "987.77", text: "B5"}
];

// Function to populate dropdown with options
function populateDropdown(selectId, defaultValue = null) {
  const select = document.getElementById(selectId);
  select.innerHTML = '';
  
  noteOptions.forEach(note => {
    const option = document.createElement('option');
    option.value = note.value;
    option.textContent = note.text;
    if (note.value === defaultValue) {
      option.selected = true;
    }
    select.appendChild(option);
  });
}

// Initialize all dropdowns when page loads
document.addEventListener('DOMContentLoaded', () => {
  // Populate SATB measure dropdowns with chord progression: C ‚Üí F ‚Üí G ‚Üí C
  // Measure 1 - C Major Chord (C, E, G, C3)
  populateDropdown('m1_soprano', '261.63');  // C4
  populateDropdown('m1_alto', '329.63');     // E4  
  populateDropdown('m1_tenor', '392.00');    // G4
  populateDropdown('m1_bass', '130.81');     // C3
  
  // Measure 2 - F Major Chord  
  populateDropdown('m2_soprano', '349.23');  // F4
  populateDropdown('m2_alto', '440.00');     // A4
  populateDropdown('m2_tenor', '261.63');    // C4
  populateDropdown('m2_bass', '174.61');     // F3
  
  // Measure 3 - G Major Chord
  populateDropdown('m3_soprano', '392.00');  // G4
  populateDropdown('m3_alto', '493.88');     // B4
  populateDropdown('m3_tenor', '293.66');    // D4
  populateDropdown('m3_bass', '196.00');     // G3
  
  // Measure 4 - C Major Chord (return home)
  populateDropdown('m4_soprano', '261.63');  // C4
  populateDropdown('m4_alto', '329.63');     // E4
  populateDropdown('m4_tenor', '392.00');    // G4
  populateDropdown('m4_bass', '130.81');     // C3
});

// Update master volume display
document.getElementById('masterVolume').addEventListener('input', (e) => {
  document.getElementById('masterVolumeValue').textContent = e.target.value + '%';
});

// Add 4-Measure SATB playback
document.getElementById('playSATB').addEventListener('click', () => {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
  
  play4MeasureSATB();
});


function playSATB(frequencies, duration, startTime = 0, voiceGains = [1, 1, 1, 1]) {
  // Array to store all oscillators for SATB
  const oscillators = [];
  const gainNodes = [];
  
  // Create a master gain node for the entire SATB harmony
  const masterGain = audioContext.createGain();
  masterGain.connect(audioContext.destination);
  
  // Get master volume
  const masterVolume = document.getElementById('masterVolume').value / 100;
  
  // Voice names for gain control
  const voiceNames = ['soprano', 'alto', 'tenor', 'bass'];
  
  // Create oscillator for each SATB voice
  frequencies.forEach((frequency, index) => {
    // Create oscillator (sound source)
    const oscillator = audioContext.createOscillator();
    
    // Create individual gain node for this voice
    const gainNode = audioContext.createGain();
    
    // Connect: oscillator -> individual gain -> master gain -> speakers
    oscillator.connect(gainNode);
    gainNode.connect(masterGain);
    
    // Set frequency and waveform
    oscillator.frequency.value = frequency;
    oscillator.type = 'sine';
    
    // Get individual voice gain from slider
    const voiceGainSlider = document.getElementById(`${voiceNames[index]}Gain`);
    const voiceGainValue = voiceGainSlider ? voiceGainSlider.value / 100 : 0.8;
    
    // Set individual voice gain
    gainNode.gain.value = voiceGainValue * 0.25; // Scale down to prevent clipping
    
    // Store references
    oscillators.push(oscillator);
    gainNodes.push(gainNode);
  });
  
  // Apply ADSR envelope to master gain
  const now = audioContext.currentTime + startTime;
  masterGain.gain.setValueAtTime(0, now);                                    // Start at 0
  masterGain.gain.linearRampToValueAtTime(masterVolume, now + 0.05);         // Attack (50ms)
  masterGain.gain.linearRampToValueAtTime(masterVolume * 0.9, now + 0.1);    // Decay
  masterGain.gain.linearRampToValueAtTime(masterVolume * 0.9, now + duration - 0.1); // Sustain
  masterGain.gain.linearRampToValueAtTime(0, now + duration);                // Release
  
  // Start all oscillators at scheduled time
  oscillators.forEach(oscillator => {
    oscillator.start(now);
    oscillator.stop(now + duration);
  });
}

function play4MeasureSATB() {
  const measureDuration = 1.2; // 1.2 seconds per measure
  
  // Get all measure data
  const measures = [];
  for (let i = 1; i <= 4; i++) {
    const soprano = parseFloat(document.getElementById(`m${i}_soprano`).value);
    const alto = parseFloat(document.getElementById(`m${i}_alto`).value);
    const tenor = parseFloat(document.getElementById(`m${i}_tenor`).value);
    const bass = parseFloat(document.getElementById(`m${i}_bass`).value);
    
    measures.push({
      frequencies: [soprano, alto, tenor, bass],
      measure: i
    });
  }
  
  // Schedule all measures using Web Audio API timing
  measures.forEach((measure, index) => {
    const startTime = index * measureDuration;
    playSATB(measure.frequencies, measureDuration, startTime);
  });
  
  // Visual feedback
  document.getElementById('playSATB').style.background = '#7B1FA2';
  document.getElementById('playSATB').textContent = 'üéµ Playing...';
  
  // Reset button after playback
  setTimeout(() => {
    document.getElementById('playSATB').style.background = '#9C27B0';
    document.getElementById('playSATB').textContent = '‚ñ∂Ô∏è Play Composition';
  }, measureDuration * 4 * 1000);
}
</script>
