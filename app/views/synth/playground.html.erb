<div style="padding: 40px; font-family: system-ui; max-width: 1200px; margin: 0 auto;">
  <h1 style="text-align: center; color: #333;">üéµ VoxQuad SATB Matrix</h1>
  
  <!-- SATB Matrix -->
  <div style="margin: 30px 0; padding: 30px; background: #f8f4ff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
    
    <!-- Voice Controls -->
    <div style="margin-bottom: 20px; display: grid; grid-template-columns: 120px 1fr 1fr 1fr 1fr; gap: 15px; align-items: center;">
      <div></div>
      <div style="text-align: center;">
        <select id="chord_m1" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px; font-weight: bold; background: #fff; border: 2px solid #ddd;">
          <option value="">All Notes</option>
        </select>
      </div>
      <div style="text-align: center;">
        <select id="chord_m2" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px; font-weight: bold; background: #fff; border: 2px solid #ddd;">
          <option value="">All Notes</option>
        </select>
      </div>
      <div style="text-align: center;">
        <select id="chord_m3" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px; font-weight: bold; background: #fff; border: 2px solid #ddd;">
          <option value="">All Notes</option>
        </select>
      </div>
      <div style="text-align: center;">
        <select id="chord_m4" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px; font-weight: bold; background: #fff; border: 2px solid #ddd;">
          <option value="">All Notes</option>
        </select>
      </div>
    </div>
    
    <!-- Soprano Row -->
    <div style="margin-bottom: 15px; display: grid; grid-template-columns: 120px 1fr 1fr 1fr 1fr; gap: 15px; align-items: center; padding: 10px; background: rgba(255, 192, 203, 0.2); border-radius: 8px;">
      <div style="display: flex; align-items: center; gap: 10px;">
        <strong style="color: #d63384;">Soprano</strong>
        <input type="range" id="sopranoGain" min="0" max="100" value="80" style="width: 50px;" title="Soprano Volume">
      </div>
      <select id="m1_soprano" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px;"></select>
      <select id="m2_soprano" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px;"></select>
      <select id="m3_soprano" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px;"></select>
      <select id="m4_soprano" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px;"></select>
    </div>
    
    <!-- Alto Row -->
    <div style="margin-bottom: 15px; display: grid; grid-template-columns: 120px 1fr 1fr 1fr 1fr; gap: 15px; align-items: center; padding: 10px; background: rgba(255, 193, 7, 0.2); border-radius: 8px;">
      <div style="display: flex; align-items: center; gap: 10px;">
        <strong style="color: #fd7e14;">Alto</strong>
        <input type="range" id="altoGain" min="0" max="100" value="70" style="width: 50px;" title="Alto Volume">
      </div>
      <select id="m1_alto" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px;"></select>
      <select id="m2_alto" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px;"></select>
      <select id="m3_alto" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px;"></select>
      <select id="m4_alto" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px;"></select>
    </div>
    
    <!-- Tenor Row -->
    <div style="margin-bottom: 15px; display: grid; grid-template-columns: 120px 1fr 1fr 1fr 1fr; gap: 15px; align-items: center; padding: 10px; background: rgba(25, 135, 84, 0.2); border-radius: 8px;">
      <div style="display: flex; align-items: center; gap: 10px;">
        <strong style="color: #198754;">Tenor</strong>
        <input type="range" id="tenorGain" min="0" max="100" value="70" style="width: 50px;" title="Tenor Volume">
      </div>
      <select id="m1_tenor" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px;"></select>
      <select id="m2_tenor" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px;"></select>
      <select id="m3_tenor" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px;"></select>
      <select id="m4_tenor" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px;"></select>
    </div>
    
    <!-- Bass Row -->
    <div style="margin-bottom: 20px; display: grid; grid-template-columns: 120px 1fr 1fr 1fr 1fr; gap: 15px; align-items: center; padding: 10px; background: rgba(13, 110, 253, 0.2); border-radius: 8px;">
      <div style="display: flex; align-items: center; gap: 10px;">
        <strong style="color: #0d6efd;">Bass</strong>
        <input type="range" id="bassGain" min="0" max="100" value="90" style="width: 50px;" title="Bass Volume">
      </div>
      <select id="m1_bass" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px;"></select>
      <select id="m2_bass" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px;"></select>
      <select id="m3_bass" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px;"></select>
      <select id="m4_bass" style="padding: 8px; font-size: 16px; width: 100%; border-radius: 4px;"></select>
    </div>
    
    <!-- Controls -->
    <div style="text-align: center; border-top: 2px solid rgba(156, 39, 176, 0.3); padding-top: 20px;">
      <div style="margin-bottom: 15px;">
        <label style="margin-right: 10px; font-weight: bold;">Master Volume:</label>
        <input type="range" id="masterVolume" min="0" max="100" value="40" style="width: 150px;">
        <span id="masterVolumeValue" style="margin-left: 10px;">40%</span>
      </div>
      
      <button id="playSATB" style="padding: 15px 50px; font-size: 20px; cursor: pointer; background: #9C27B0; color: white; border: none; border-radius: 8px; box-shadow: 0 4px 8px rgba(156, 39, 176, 0.3);">
        ‚ñ∂Ô∏è Play Composition
      </button>
    </div>
  </div>
</div>

<script>
// Create Web Audio API context
let audioContext = null;

// Musical note system using equal temperament
// Formula: f = 440 √ó 2^((midiNote - 69) / 12)
// A4 = 440 Hz = MIDI note 69

// Chromatic note names and their MIDI numbers (ordered C, C#, D, D#, E, F, F#, G, G#, A, A#, B)
const CHROMATIC_NOTES = [
  // Octave 2 (MIDI 36-47) - Starting with C
  {name: 'C2', midi: 36}, {name: 'C#2/Db2', midi: 37}, {name: 'D2', midi: 38}, {name: 'D#2/Eb2', midi: 39},
  {name: 'E2', midi: 40}, {name: 'F2', midi: 41}, {name: 'F#2/Gb2', midi: 42}, {name: 'G2', midi: 43},
  {name: 'G#2/Ab2', midi: 44}, {name: 'A2', midi: 45}, {name: 'A#2/Bb2', midi: 46}, {name: 'B2', midi: 47},
  
  // Octave 3 (MIDI 48-59) - Starting with C
  {name: 'C3', midi: 48}, {name: 'C#3/Db3', midi: 49}, {name: 'D3', midi: 50}, {name: 'D#3/Eb3', midi: 51},
  {name: 'E3', midi: 52}, {name: 'F3', midi: 53}, {name: 'F#3/Gb3', midi: 54}, {name: 'G3', midi: 55},
  {name: 'G#3/Ab3', midi: 56}, {name: 'A3', midi: 57}, {name: 'A#3/Bb3', midi: 58}, {name: 'B3', midi: 59},
  
  // Octave 4 (MIDI 60-71) - Starting with C
  {name: 'C4', midi: 60}, {name: 'C#4/Db4', midi: 61}, {name: 'D4', midi: 62}, {name: 'D#4/Eb4', midi: 63},
  {name: 'E4', midi: 64}, {name: 'F4', midi: 65}, {name: 'F#4/Gb4', midi: 66}, {name: 'G4', midi: 67},
  {name: 'G#4/Ab4', midi: 68}, {name: 'A4', midi: 69}, {name: 'A#4/Bb4', midi: 70}, {name: 'B4', midi: 71},
  
  // Octave 5 (MIDI 72-83) - Starting with C
  {name: 'C5', midi: 72}, {name: 'C#5/Db5', midi: 73}, {name: 'D5', midi: 74}, {name: 'D#5/Eb5', midi: 75},
  {name: 'E5', midi: 76}, {name: 'F5', midi: 77}, {name: 'F#5/Gb5', midi: 78}, {name: 'G5', midi: 79},
  {name: 'G#5/Ab5', midi: 80}, {name: 'A5', midi: 81}, {name: 'A#5/Bb5', midi: 82}, {name: 'B5', midi: 83}
];

// Chord definitions with their component notes (all octaves included)
const CHORD_DEFINITIONS = {
  // Empty chord - no filtering
  '': { name: 'All Notes', notes: [] },
  
  // Major chords
  'C': { name: 'C Major', notes: ['C', 'E', 'G'] },
  'F': { name: 'F Major', notes: ['F', 'A', 'C'] },
  'G': { name: 'G Major', notes: ['G', 'B', 'D'] },
  'D': { name: 'D Major', notes: ['D', 'F#/Gb', 'A'] },
  'A': { name: 'A Major', notes: ['A', 'C#/Db', 'E'] },
  'E': { name: 'E Major', notes: ['E', 'G#/Ab', 'B'] },
  'B': { name: 'B Major', notes: ['B', 'D#/Eb', 'F#/Gb'] },
  
  // Minor chords  
  'Am': { name: 'A minor', notes: ['A', 'C', 'E'] },
  'Dm': { name: 'D minor', notes: ['D', 'F', 'A'] },
  'Em': { name: 'E minor', notes: ['E', 'G', 'B'] },
  'Bm': { name: 'B minor', notes: ['B', 'D', 'F#/Gb'] },
  'Fm': { name: 'F minor', notes: ['F', 'G#/Ab', 'C'] },
  'Cm': { name: 'C minor', notes: ['C', 'D#/Eb', 'G'] },
  'Gm': { name: 'G minor', notes: ['G', 'A#/Bb', 'D'] },
  
  // Dominant 7th chords
  'G7': { name: 'G7', notes: ['G', 'B', 'D', 'F'] },
  'C7': { name: 'C7', notes: ['C', 'E', 'G', 'A#/Bb'] },
  'F7': { name: 'F7', notes: ['F', 'A', 'C', 'D#/Eb'] },
  'D7': { name: 'D7', notes: ['D', 'F#/Gb', 'A', 'C'] },
  'A7': { name: 'A7', notes: ['A', 'C#/Db', 'E', 'G'] },
  'E7': { name: 'E7', notes: ['E', 'G#/Ab', 'B', 'D'] },
  'B7': { name: 'B7', notes: ['B', 'D#/Eb', 'F#/Gb', 'A'] }
};

// Function to check if a note belongs to a chord (any octave)
function noteInChord(noteName, chordNotes) {
  if (chordNotes.length === 0) return true; // Empty chord = all notes allowed
  
  // Extract base note name (remove octave number)
  const baseName = noteName.replace(/[2-5]$/, '');
  
  return chordNotes.some(chordNote => {
    // Handle enharmonic equivalents (e.g., F#/Gb matches both F# and Gb)
    if (chordNote.includes('/')) {
      const [sharp, flat] = chordNote.split('/');
      return baseName === sharp || baseName === flat;
    }
    return baseName === chordNote;
  });
}


// Calculate frequency from MIDI note number using equal temperament
function midiToFrequency(midiNote) {
  return 440 * Math.pow(2, (midiNote - 69) / 12);
}

// Create note-to-frequency mapping
const NOTE_FREQUENCIES = {};
CHROMATIC_NOTES.forEach(note => {
  const frequency = midiToFrequency(note.midi);
  NOTE_FREQUENCIES[note.name] = frequency;
});

// Generate note options from chromatic notes  
const noteOptions = CHROMATIC_NOTES.map(note => ({
  value: midiToFrequency(note.midi).toFixed(2),
  text: note.name
}));

// Function to populate chord dropdown with all available chords (ordered)
function populateChordDropdown(selectId) {
  const select = document.getElementById(selectId);
  select.innerHTML = '<option value="">All Notes</option>'; // Default empty chord
  
  // Define chord order starting with C
  const chordOrder = [
    'C', 'Dm', 'Em', 'F', 'G', 'Am', 'G7',  // Key of C major progression
    'D', 'E', 'A', 'B',                      // Other majors
    'Bm', 'Fm', 'Cm', 'Gm',                 // Other minors  
    'C7', 'F7', 'D7', 'A7', 'E7', 'B7'      // Other 7ths
  ];
  
  chordOrder.forEach(chordSymbol => {
    if (CHORD_DEFINITIONS[chordSymbol]) {
      const chord = CHORD_DEFINITIONS[chordSymbol];
      const option = document.createElement('option');
      option.value = chordSymbol;
      option.textContent = chord.name;
      select.appendChild(option);
    }
  });
}

// Function to populate note dropdown with optional chord filtering
function populateDropdown(selectId, defaultValue = null, chordFilter = []) {
  const select = document.getElementById(selectId);
  select.innerHTML = '';
  
  // Filter notes based on chord if provided
  const filteredOptions = chordFilter.length === 0 ? noteOptions : 
    noteOptions.filter(note => noteInChord(note.text, chordFilter));
  
  filteredOptions.forEach(note => {
    const option = document.createElement('option');
    option.value = note.value;
    option.textContent = note.text;
    if (note.value === defaultValue) {
      option.selected = true;
    }
    select.appendChild(option);
  });
  
  // If no notes match the filter, fallback to first available note
  if (filteredOptions.length === 0) {
    console.warn(`No notes found for chord filter:`, chordFilter);
    populateDropdown(selectId, defaultValue, []); // Fallback to all notes
  }
}

// Helper function to get frequency by note name
function getFrequencyByNote(noteName) {
  return NOTE_FREQUENCIES[noteName].toFixed(2);
}

// Handle chord change for a specific measure
function handleChordChange(measureNumber) {
  const chordSelect = document.getElementById(`chord_m${measureNumber}`);
  const selectedChord = chordSelect.value;
  const chordNotes = selectedChord ? CHORD_DEFINITIONS[selectedChord].notes : [];
  
  // Get current voice selections to try to maintain them if possible
  const currentSelections = {
    soprano: document.getElementById(`m${measureNumber}_soprano`).value,
    alto: document.getElementById(`m${measureNumber}_alto`).value,
    tenor: document.getElementById(`m${measureNumber}_tenor`).value,
    bass: document.getElementById(`m${measureNumber}_bass`).value
  };
  
  // Repopulate voice dropdowns with chord filtering
  const voiceIds = ['soprano', 'alto', 'tenor', 'bass'];
  voiceIds.forEach(voice => {
    const selectId = `m${measureNumber}_${voice}`;
    const currentValue = currentSelections[voice];
    
    // Check if current selection is still valid for the new chord
    if (chordNotes.length === 0) {
      // No chord filtering - keep current selection
      populateDropdown(selectId, currentValue, []);
    } else {
      // Apply chord filtering
      populateDropdown(selectId, null, chordNotes);
      
      // Try to maintain current selection if it's still valid
      const select = document.getElementById(selectId);
      const validOptions = Array.from(select.options).map(opt => opt.value);
      if (validOptions.includes(currentValue)) {
        select.value = currentValue;
      }
      // If current selection is not valid, it will default to first option
    }
  });
}

// Initialize all dropdowns when page loads
document.addEventListener('DOMContentLoaded', () => {
  // Populate chord dropdowns
  for (let i = 1; i <= 4; i++) {
    populateChordDropdown(`chord_m${i}`);
    
    // Add event listener for chord changes
    document.getElementById(`chord_m${i}`).addEventListener('change', () => {
      handleChordChange(i);
    });
  }
  
  // Initialize with barbershop progression and set matching chords
  // M1: C4-E4-G3-C3 (C Major)
  document.getElementById('chord_m1').value = 'C';
  populateDropdown('m1_soprano', getFrequencyByNote('C4'), CHORD_DEFINITIONS.C.notes);
  populateDropdown('m1_alto', getFrequencyByNote('E4'), CHORD_DEFINITIONS.C.notes);
  populateDropdown('m1_tenor', getFrequencyByNote('G3'), CHORD_DEFINITIONS.C.notes);
  populateDropdown('m1_bass', getFrequencyByNote('C3'), CHORD_DEFINITIONS.C.notes);
  
  // M2: F4-C4-A3-F3 (F Major) 
  document.getElementById('chord_m2').value = 'F';
  populateDropdown('m2_soprano', getFrequencyByNote('F4'), CHORD_DEFINITIONS.F.notes);
  populateDropdown('m2_alto', getFrequencyByNote('C4'), CHORD_DEFINITIONS.F.notes);
  populateDropdown('m2_tenor', getFrequencyByNote('A3'), CHORD_DEFINITIONS.F.notes);
  populateDropdown('m2_bass', getFrequencyByNote('F3'), CHORD_DEFINITIONS.F.notes);
  
  // M3: F4-D4-B3-G3 (G7)
  document.getElementById('chord_m3').value = 'G7';
  populateDropdown('m3_soprano', getFrequencyByNote('F4'), CHORD_DEFINITIONS.G7.notes);
  populateDropdown('m3_alto', getFrequencyByNote('D4'), CHORD_DEFINITIONS.G7.notes);
  populateDropdown('m3_tenor', getFrequencyByNote('B3'), CHORD_DEFINITIONS.G7.notes);
  populateDropdown('m3_bass', getFrequencyByNote('G3'), CHORD_DEFINITIONS.G7.notes);
  
  // M4: G4-E4-C4-C3 (C Major)
  document.getElementById('chord_m4').value = 'C';
  populateDropdown('m4_soprano', getFrequencyByNote('G4'), CHORD_DEFINITIONS.C.notes);
  populateDropdown('m4_alto', getFrequencyByNote('E4'), CHORD_DEFINITIONS.C.notes);
  populateDropdown('m4_tenor', getFrequencyByNote('C4'), CHORD_DEFINITIONS.C.notes);
  populateDropdown('m4_bass', getFrequencyByNote('C3'), CHORD_DEFINITIONS.C.notes);
});

// Update master volume display
document.getElementById('masterVolume').addEventListener('input', (e) => {
  document.getElementById('masterVolumeValue').textContent = e.target.value + '%';
});

// Add 4-Measure SATB playback
document.getElementById('playSATB').addEventListener('click', () => {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
  
  play4MeasureSATB();
});


// Vowel formant frequencies (F1, F2) based on acoustic research
const VOWEL_FORMANTS = {
  a: [827, 1542],  // "bat" - open central vowel
  e: [430, 2336],  // "bet" - mid front vowel  
  i: [100, 3379],  // "beet" - close front vowel
  o: [562, 3577],  // "bought" - mid back vowel
  u: [200, 1500]   // "boot" - close back vowel
};

// Voice-specific formant frequency scaling
const VOICE_SCALING = {
  soprano: 1.2,   // Higher formants
  alto: 1.1,      // Slightly higher
  tenor: 1.0,     // Base frequencies  
  bass: 0.85      // Lower formants
};

// Create formant synthesizer based on acoustic principles
function createFormantVoice(frequency, voiceType, vowel = 'a') {
  // Get formant frequencies for the vowel
  const baseFormants = VOWEL_FORMANTS[vowel] || VOWEL_FORMANTS.a;
  const scalingFactor = VOICE_SCALING[voiceType] || 1.0;
  
  // Scale formants for voice type
  const f1 = baseFormants[0] * scalingFactor;
  const f2 = baseFormants[1] * scalingFactor;
  
  // Single sawtooth source (like vocal cords)
  const source = audioContext.createOscillator();
  source.frequency.value = frequency;
  source.type = 'sawtooth';
  
  // Create resonant formant filters in SERIES (not parallel!)
  // This simulates how vocal tract actually works
  const formant1 = audioContext.createBiquadFilter();
  formant1.type = 'peaking'; // Use peaking filter for resonance
  formant1.frequency.value = f1;
  formant1.Q.value = 10; // High Q for strong resonance
  formant1.gain.value = 12; // Boost at this frequency
  
  const formant2 = audioContext.createBiquadFilter();
  formant2.type = 'peaking';
  formant2.frequency.value = f2;
  formant2.Q.value = 15; // Even higher Q for F2
  formant2.gain.value = 8; // Less boost than F1
  
  // Lowpass to remove harsh high frequencies
  const lowpass = audioContext.createBiquadFilter();
  lowpass.type = 'lowpass';
  lowpass.frequency.value = 3000;
  lowpass.Q.value = 1;
  
  // Output gain control
  const outputGain = audioContext.createGain();
  outputGain.gain.value = 0.1; // Much quieter for peaking filters
  
  // Connect in series: source -> formant1 -> formant2 -> lowpass -> output
  source.connect(formant1);
  formant1.connect(formant2);
  formant2.connect(lowpass);
  lowpass.connect(outputGain);
  
  return { 
    oscillator: source,
    outputNode: outputGain 
  };
}

function playSATB(frequencies, duration, startTime = 0, voiceGains = [1, 1, 1, 1]) {
  const voices = [];
  const gainNodes = [];
  
  // Create master gain
  const masterGain = audioContext.createGain();
  masterGain.connect(audioContext.destination);
  
  const masterVolume = document.getElementById('masterVolume').value / 100;
  const voiceNames = ['soprano', 'alto', 'tenor', 'bass'];
  
  // Create formant voice for each SATB part
  frequencies.forEach((frequency, index) => {
    const voice = createFormantVoice(frequency, voiceNames[index], 'a');
    const gainNode = audioContext.createGain();
    
    // Connect voice -> gain -> master
    voice.outputNode.connect(gainNode);
    gainNode.connect(masterGain);
    
    // Set individual voice gain
    const voiceGainSlider = document.getElementById(`${voiceNames[index]}Gain`);
    const voiceGainValue = voiceGainSlider ? voiceGainSlider.value / 100 : 0.8;
    gainNode.gain.value = voiceGainValue * 0.4;
    
    voices.push(voice);
    gainNodes.push(gainNode);
  });
  
  // Apply ADSR envelope
  const now = audioContext.currentTime + startTime;
  masterGain.gain.setValueAtTime(0, now);
  masterGain.gain.linearRampToValueAtTime(masterVolume, now + 0.05);
  masterGain.gain.linearRampToValueAtTime(masterVolume * 0.9, now + 0.1);
  masterGain.gain.linearRampToValueAtTime(masterVolume * 0.9, now + duration - 0.1);
  masterGain.gain.linearRampToValueAtTime(0, now + duration);
  
  // Start all voices
  voices.forEach(voice => {
    voice.oscillator.start(now);
    voice.oscillator.stop(now + duration);
  });
}

function play4MeasureSATB() {
  const measureDuration = 1.2; // 1.2 seconds per measure
  
  // Get all measure data
  const measures = [];
  for (let i = 1; i <= 4; i++) {
    const soprano = parseFloat(document.getElementById(`m${i}_soprano`).value);
    const alto = parseFloat(document.getElementById(`m${i}_alto`).value);
    const tenor = parseFloat(document.getElementById(`m${i}_tenor`).value);
    const bass = parseFloat(document.getElementById(`m${i}_bass`).value);
    
    measures.push({
      frequencies: [soprano, alto, tenor, bass],
      measure: i
    });
  }
  
  // Schedule all measures using Web Audio API timing
  measures.forEach((measure, index) => {
    const startTime = index * measureDuration;
    playSATB(measure.frequencies, measureDuration, startTime);
  });
  
  // Visual feedback
  document.getElementById('playSATB').style.background = '#7B1FA2';
  document.getElementById('playSATB').textContent = 'üéµ Playing...';
  
  // Reset button after playback
  setTimeout(() => {
    document.getElementById('playSATB').style.background = '#9C27B0';
    document.getElementById('playSATB').textContent = '‚ñ∂Ô∏è Play Composition';
  }, measureDuration * 4 * 1000);
}
</script>
